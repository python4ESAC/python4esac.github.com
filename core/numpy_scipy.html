

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>NumPy &mdash; Python4Astronomers v1.1 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Python4Astronomers v1.1 documentation" href="../index.html" />
    <link rel="up" title="Core packages for analysis: IPython, NumPy, and SciPy" href="core.html" />
    <link rel="next" title="NumPy record arrays" href="numpy_recarray.html" />
    <link rel="prev" title="IPython" href="ipython.html" />
 
<script type="text/javascript"> 
$(document).ready(function(){

$(".flip0").click(function(){
    $(".panel0").slideToggle("normal");
  });

$(".flip1").click(function(){
    $(".panel1").slideToggle("normal");
  });

$(".flip2").click(function(){
    $(".panel2").slideToggle("normal");
  });

$(".flip3").click(function(){
    $(".panel3").slideToggle("normal");
  });

$(".flip4").click(function(){
    $(".panel4").slideToggle("normal");
  });

$(".flip5").click(function(){
    $(".panel5").slideToggle("normal");
  });

$(".flip6").click(function(){
    $(".panel6").slideToggle("normal");
  });

$(".flip7").click(function(){
    $(".panel7").slideToggle("normal");
  });

$(".flip8").click(function(){
    $(".panel8").slideToggle("normal");
  });

$(".flip9").click(function(){
    $(".panel9").slideToggle("normal");
  });

});
</script>
 
<style type="text/css"> 

div.panel0,p.flip0
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip0
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel0
{
display:none;
}

div.panel1,p.flip1
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip1
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel1
{
display:none;
}

div.panel2,p.flip2
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip2
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel2
{
display:none;
}

div.panel3,p.flip3
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip3
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel3
{
display:none;
}

div.panel4,p.flip4
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip4
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel4
{
display:none;
}

div.panel5,p.flip5
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip5
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel5
{
display:none;
}

div.panel6,p.flip6
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip6
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel6
{
display:none;
}

div.panel7,p.flip7
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip7
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel7
{
display:none;
}

div.panel8,p.flip8
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip8
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel8
{
display:none;
}

div.panel9,p.flip9
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip9
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel9
{
display:none;
}

</style>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18709417-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="numpy_recarray.html" title="NumPy record arrays"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ipython.html" title="IPython"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Python4Astronomers v1.1 documentation</a> &raquo;</li>
          <li><a href="core.html" accesskey="U">Core packages for analysis: IPython, NumPy, and SciPy</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">NumPy</a><ul>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#read-in-the-2-d-image">Read in the 2-d image</a></li>
<li><a class="reference internal" href="#numpy-basics">NumPy basics</a></li>
<li><a class="reference internal" href="#plot-the-spatial-profile-and-raw-spectrum">Plot the spatial profile and raw spectrum</a></li>
<li><a class="reference internal" href="#filter-cosmic-rays-from-the-background">Filter cosmic rays from the background</a></li>
<li><a class="reference internal" href="#fit-the-background">Fit the background</a></li>
<li><a class="reference internal" href="#sum-the-source-signal">Sum the source signal</a></li>
<li><a class="reference internal" href="#scipy">SciPy</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ipython.html"
                        title="previous chapter">IPython</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="numpy_recarray.html"
                        title="next chapter">NumPy record arrays</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/core/numpy_scipy.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="numpy">
<h1><a class="toc-backref" href="#id1">NumPy</a><a class="headerlink" href="#numpy" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#numpy" id="id1">NumPy</a><ul>
<li><a class="reference internal" href="#setup" id="id2">Setup</a></li>
<li><a class="reference internal" href="#read-in-the-2-d-image" id="id3">Read in the 2-d image</a></li>
<li><a class="reference internal" href="#numpy-basics" id="id4">NumPy basics</a><ul>
<li><a class="reference internal" href="#making-arrays" id="id5">Making arrays</a></li>
<li><a class="reference internal" href="#array-access-and-slicing" id="id6">Array access and slicing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plot-the-spatial-profile-and-raw-spectrum" id="id7">Plot the spatial profile and raw spectrum</a></li>
<li><a class="reference internal" href="#filter-cosmic-rays-from-the-background" id="id8">Filter cosmic rays from the background</a></li>
<li><a class="reference internal" href="#fit-the-background" id="id9">Fit the background</a></li>
<li><a class="reference internal" href="#sum-the-source-signal" id="id10">Sum the source signal</a></li>
<li><a class="reference internal" href="#scipy" id="id11">SciPy</a></li>
</ul>
</li>
</ul>
</div>
<p><a class="reference internal" href="#numpy">NumPy</a> is at the core of nearly every scientific Python application or
module since it provides a fast N-d array datatype that can be manipulated in a
vectorized form.  This will be familiar to users of IDL or Matlab.</p>
<p>NumPy has a good and systematic <a class="reference external" href="http://www.scipy.org/Tentative_NumPy_Tutorial">basic tutorial</a> available.  It is highly
recommended that you read this tutorial to fill in the gaps left by this
workshop, but on its own it&#8217;s a bit dry for the impatient astronomer.</p>
<p>Here we&#8217;ll learn NumPy by performing a very simple reduction of a
2-dimensional long slit spectrum (3C120 from HST/STIS):</p>
<ul class="simple">
<li>Read in the 2-d image</li>
<li>Plot the spatial profile and raw spectrum</li>
<li>Filter cosmic rays from the background</li>
<li>Fit for the background and subtract</li>
<li>Sum the source signal</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"><strong>2-d longslit image</strong></th>
<th class="head"><strong>Final 1-d spectrum</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="first last reference internal image-reference" href="../_images/3c120.png"><img alt="../_images/3c120.png" src="../_images/3c120.png" style="width: 378.0px; height: 290.5px;" /></a>
</td>
<td><a class="first last reference internal image-reference" href="../_images/3c120_spec.gif"><img alt="../_images/3c120_spec.gif" src="../_images/3c120_spec.gif" style="width: 382.5px; height: 306.0px;" /></a>
</td>
</tr>
</tbody>
</table>
<p class="flip0">Why NumPy? (Click to Show/Hide)</p> <div class="panel0"><div class="admonition-info admonition ">
<p class="first admonition-title">INFO</p>
<p>Python&#8217;s ease-of-use often comes at a price: speed. Let&#8217;s try to compute the
sine of 20 million (uniform) random floats using Python&#8217;s standard modules, and
time it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span> <span class="c"># get access to CPU time</span>
<span class="kn">import</span> <span class="nn">math</span> <span class="c"># standard module implementing mathematical operators</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="c"># generate random numbers</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20000000</span><span class="p">):</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()))</span>
<span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span>
</pre></div>
</div>
<p>This needs <strong>13.3424</strong> seconds (on a Dell Dual Core Genuine Intel(R), T2600, 2.16GHz, 32-bit processor) of execution time. We can gain ~50% with some
tricks (list comprehension, generator and local variables):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sin</span><span class="p">,</span><span class="n">rand</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span><span class="n">random</span><span class="o">.</span><span class="n">random</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">sin</span><span class="p">(</span><span class="n">rand</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">20000000</span><span class="p">)]</span> <span class="c"># in Python 3, replace xrange with range</span>
</pre></div>
</div>
<p>Which tops at <strong>8.6610</strong> seconds. With numpy, we can gain another 50%, <strong>and</strong>
have a much cleaner implementation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20000000</span><span class="p">))</span>
</pre></div>
</div>
<p>The latter takes <strong>3.9020</strong> seconds to run. A pure FORTRAN program is, however,
still almost 50% faster than numpy (2.2641 seconds).</p>
<p>Basically, numpy provides vectorized functions written in C or FORTRAN that
can act on pure Python objects, with a little bit of function-call overhead.
Most of the looping is done in C or FORTRAN, avoiding the expensive <tt class="docutils literal"><span class="pre">for</span></tt>
loops in pure Python.</p>
<p class="last">Sometimes doing things in a vectorized way is not possible or just too
confusing.  There is an art here and the basic answer is that if it runs
fast enough then you are good to go.  Otherwise things need to be vectorized
or maybe coded in C or Fortran.</p>
</div>
</div><div class="section" id="setup">
<h2><a class="toc-backref" href="#id2">Setup</a><a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Before going further you need to get the example data and script files for
the workshop.  Now that you have a working Python installation we can do this
without worrying about details of the platform (e.g. linux has wget,
Mac has curl, Windows might not have tar, etc etc).</p>
<p>Now start IPython (<tt class="docutils literal"><span class="pre">ipython</span> <span class="pre">--pylab</span></tt>) or use your existing session and enter:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [50]: </span><span class="kn">import</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">tarfile</span>

<span class="gp">In [51]: </span><span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://python4astronomers.github.com/core/core_examples.tar&#39;</span>

<span class="gp">In [52]: </span><span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r|&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

<span class="gp">In [53]: </span><span class="n">cd</span> <span class="n">py4ast</span><span class="o">/</span><span class="n">core</span>
<span class="go">/home/pieterd/python4esac/python4ESAC/source/py4ast/core</span>

<span class="gp">In [54]: </span><span class="n">ls</span>
</pre></div>
</div>
<p>Leave this IPython session open for the rest of the workshop.</p>
<div class="admonition-exercise-for-the-interested-reader-how-did-that-code-above-work admonition ">
<p class="first admonition-title">Exercise (for the interested reader): How did that code above work?</p>
<p class="last">Explain what&#8217;s happening in each part of the previous code snippet to grab
the file at a URL and untar it.  Google on &#8220;python urllib2&#8221; and &#8220;python
tarfile&#8221; to find the relevant module docs.  Figure out how you would
use the <tt class="docutils literal"><span class="pre">tarfile</span></tt> module to create a tarfile.</p>
</div>
<p class="flip1">Click to Show/Hide Solution</p> <div class="panel1"><ul class="simple">
<li><tt class="docutils literal"><span class="pre">urllib2.urlopen(url)</span></tt> opens the URL as a streaming file-like object</li>
<li><tt class="docutils literal"><span class="pre">mode='r|'</span> <span class="pre">means</span> <span class="pre">``tarfile</span></tt> is expecting a streaming file-like object
with no ability to seek in the file</li>
<li><tt class="docutils literal"><span class="pre">tarfile.open(..).extractall</span></tt> then extracts the tar archive</li>
</ul>
<p>Creating a tarfile is left for the reader to solve.</p>
</div></div>
<div class="section" id="read-in-the-2-d-image">
<h2><a class="toc-backref" href="#id3">Read in the 2-d image</a><a class="headerlink" href="#read-in-the-2-d-image" title="Permalink to this headline">¶</a></h2>
<p>First read in the long-slit spectrum data.  The standard file format available
for download from <a class="reference external" href="http://archive.stsci.edu/hst/">MAST</a> is a FITS file with
three identically sized images providing the 2-d spectral intensity, error
values, and data quality for each pixel.  The slit direction is along the rows
(up and down) and wavelength is in columns (left to right).</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [55]: </span><span class="kn">import</span> <span class="nn">pyfits</span>

<span class="gp">In [56]: </span><span class="n">hdus</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;3c120_stis.fits.gz&#39;</span><span class="p">)</span>

<span class="gp">In [57]: </span><span class="n">hdus</span>
<span class="gr">Out[57]: </span>
<span class="go">[&lt;pyfits.core.PrimaryHDU object at 0xb728b0c&gt;,</span>
<span class="go"> &lt;pyfits.core.ImageHDU object at 0xb6a372c&gt;,</span>
<span class="go"> &lt;pyfits.core.ImageHDU object at 0xb89f32c&gt;,</span>
<span class="go"> &lt;pyfits.core.ImageHDU object at 0xb6acaac&gt;]</span>
</pre></div>
</div>
<p>Type <tt class="docutils literal"><span class="pre">?hdus</span></tt> to get a little more detail on the <tt class="docutils literal"><span class="pre">hdus</span></tt> object.</p>
<p>Now give meaningful names to each of the three images that are available in the
FITS HDU list.  You can access element <tt class="docutils literal"><span class="pre">n</span></tt> in a list with the index <tt class="docutils literal"><span class="pre">[n]</span></tt>,
where the count starts from 0:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [58]: </span><span class="n">primary</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c"># Primary (NULL) header data unit</span>

<span class="gp">In [59]: </span><span class="n">img</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>      <span class="c"># Intensity data</span>

<span class="gp">In [60]: </span><span class="n">err</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>      <span class="c"># Error per pixel</span>

<span class="gp">In [61]: </span><span class="n">dq</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>       <span class="c"># Data quality per pixel</span>
</pre></div>
</div>
<p class="flip2">Click to Show/Hide Tip: pyFITS </p> <div class="panel2"><div class="admonition-tip-pyfits admonition ">
<p class="first admonition-title">TIP: pyFITS</p>
<p>The HDUList from a FITS file acts like an ordered dictionary: instead of accessing
via an index <tt class="docutils literal"><span class="pre">n</span></tt>, you can also access the extensions by <em>name</em>:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [62]: </span><span class="n">img</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="s">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>      <span class="c"># Intensity data</span>

<span class="gp">In [63]: </span><span class="n">err</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="s">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>      <span class="c"># Error per pixel</span>

<span class="gp">In [64]: </span><span class="n">dq</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="s">&#39;DQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>       <span class="c"># Data quality per pixel</span>
</pre></div>
</div>
<p>You can find (and set) the name of an extension throught the header keyword
<tt class="docutils literal"><span class="pre">EXTNAME</span></tt> (case-insensitive).</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [65]: </span><span class="n">hdus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;extname&#39;</span><span class="p">]</span>
<span class="gr">Out[65]: </span><span class="s">&#39;SCI&#39;</span>
</pre></div>
</div>
<p class="last">A frequently used convention is to store scientific data in an extension named
<tt class="docutils literal"><span class="pre">SCI</span></tt>. For more information on FITS files and pyFITS, see the <a class="reference external" href="http://stsdas.stsci.edu/download/wikidocs/The_PyFITS_Handbook.pdf">pyFITS documentation</a></p>
</div>
</div><p>Next have a look at the images using one of the standard Matplotlib plotting
functions:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [66]: </span><span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span> <span class="c"># not needed when you run ipython with the pylab option</span>

<span class="gp">In [67]: </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>  <span class="c"># not needed when you run ipython with the pylab option</span>

<span class="gp">In [68]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="gr">Out[68]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb68220c</span><span class="o">&gt;</span>
</pre></div>
</div>
<p class="flip4">Click to Show/Hide Tip: matplotlib widget</p> <div class="panel4"><div class="admonition-tip-matplotlib-widget admonition ">
<p class="first admonition-title">TIP: matplotlib widget</p>
<p>The matplotlib widget that appears when you make a plot in IPython (or whenever
you call <tt class="docutils literal"><span class="pre">plt.show()</span></tt> in a script), is highly interactive. You can:</p>
<ul class="last simple">
<li><em>zoom in</em> by clicking on the <em>zoom</em> icon and dragging a rectangle</li>
<li><em>pan</em> by clicking on the <em>pan</em> icon and dragging the image around</li>
<li><em>pan</em> and <em>zoom</em> by clicking on the <em>pan</em> icon, click, hold and drag with the right mouse button.</li>
</ul>
</div>
</div><p>As you can see, it is hard to see things. So, let&#8217;s set a few options for this
plot. First, we want the origin in the lower left instead of the upper left
corner:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [69]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [70]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>
<span class="gr">Out[70]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb735e2c</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Second, let&#8217;s change the scaling to something more sensible. By default,
<tt class="docutils literal"><span class="pre">plt.imshow()</span></tt> scales the colorbar from the minimum to the maximum value. In
our case that is not the best option. We can set a lower and upper bound and
add a colorbar to our plot:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [71]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [72]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">65</span><span class="p">)</span>
<span class="gr">Out[72]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb007f6c</span><span class="o">&gt;</span>

<span class="gp">In [73]: </span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="gr">Out[73]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">Colorbar</span> <span class="n">instance</span> <span class="n">at</span> <span class="mh">0xaf92d8c</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Your plot should look like this (it is possible that the colormap differs,
if your matplotlib has different defaults set).</p>
<a class="reference internal image-reference" href="../_images/imgview_img.png"><img alt="../_images/imgview_img.png" src="../_images/imgview_img.png" style="width: 406.0px; height: 306.0px;" /></a>
<div class="admonition-exercise-view-the-error-and-data-quality-images admonition ">
<p class="first admonition-title">Exercise: View the error and data quality images</p>
<p class="last">Bring up a viewer window for the other two images.  Play with the toolbar
buttons on the lower-left (hint: try the four on the right first, then
imagine a web browser for the three on the left).  Does the save button
work for you?</p>
</div>
<p class="flip5">Click to Show/Hide Solution</p> <div class="panel5"><div class="highlight-python"><div class="highlight"><pre><span class="c"># Errors</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="c"># Data quality</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/imgview_err.png"><img alt="../_images/imgview_err.png" src="../_images/imgview_err.png" style="width: 406.0px; height: 306.0px;" /></a>
<a class="reference internal image-reference" href="../_images/imgview_dq.png"><img alt="../_images/imgview_dq.png" src="../_images/imgview_dq.png" style="width: 406.0px; height: 306.0px;" /></a>
</div><p>Now discover a little bit about the images you have read in, first with <tt class="docutils literal"><span class="pre">?</span></tt>:</p>
<div class="highlight-python"><pre>img?</pre>
</div>
<p>Next use <tt class="docutils literal"><span class="pre">help</span></tt> and note the slightly different information that you get:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">help</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
<p>Use tab completion to see all the methods in short form:</p>
<div class="highlight-python"><pre>img.&lt;TAB&gt;
img.T                    img.__floordiv__         img.__isub__             img.__reduce__           img.__xor__              img.dumps                img.reshape
img.__abs__              img.__format__           img.__iter__             img.__reduce_ex__        img.all                  img.fill                 img.resize
img.__add__              img.__ge__               img.__itruediv__         img.__repr__             img.any                  img.flags                img.round
img.__and__              img.__getattribute__     img.__ixor__             img.__rfloordiv__        img.argmax               img.flat                 img.searchsorted
img.__array__            img.__getitem__          img.__le__               img.__rlshift__          img.argmin               img.flatten              img.setfield
img.__array_finalize__   img.__getslice__         img.__len__              img.__rmod__             img.argsort              img.getfield             img.setflags
img.__array_interface__  img.__gt__               img.__long__             img.__rmul__             img.astype               img.imag                 img.shape
img.__array_prepare__    img.__hash__             img.__lshift__           img.__ror__              img.base                 img.item                 img.size
img.__array_priority__   img.__hex__              img.__lt__               img.__rpow__             img.byteswap             img.itemset              img.sort
img.__array_struct__     img.__iadd__             img.__mod__              img.__rrshift__          img.choose               img.itemsize             img.squeeze
img.__array_wrap__       img.__iand__             img.__mul__              img.__rshift__           img.clip                 img.max                  img.std
img.__class__            img.__idiv__             img.__ne__               img.__rsub__             img.compress             img.mean                 img.strides
img.__contains__         img.__ifloordiv__        img.__neg__              img.__rtruediv__         img.conj                 img.min                  img.sum
img.__copy__             img.__ilshift__          img.__new__              img.__rxor__             img.conjugate            img.nbytes               img.swapaxes
img.__deepcopy__         img.__imod__             img.__nonzero__          img.__setattr__          img.copy                 img.ndim                 img.take
img.__delattr__          img.__imul__             img.__oct__              img.__setitem__          img.ctypes               img.newbyteorder         img.tofile
img.__delitem__          img.__index__            img.__or__               img.__setslice__         img.cumprod              img.nonzero              img.tolist
img.__delslice__         img.__init__             img.__pos__              img.__setstate__         img.cumsum               img.prod                 img.tostring
img.__div__              img.__int__              img.__pow__              img.__sizeof__           img.data                 img.ptp                  img.trace
img.__divmod__           img.__invert__           img.__radd__             img.__str__              img.diagonal             img.put                  img.transpose
img.__doc__              img.__ior__              img.__rand__             img.__sub__              img.dot                  img.ravel                img.var
img.__eq__               img.__ipow__             img.__rdiv__             img.__subclasshook__     img.dtype                img.real                 img.view
img.__float__            img.__irshift__          img.__rdivmod__          img.__truediv__          img.dump                 img.repeat</pre>
</div>
<p>Finally find the shape of the image and its minimum value:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [74]: </span><span class="n">img</span><span class="o">.</span><span class="n">shape</span>  <span class="c"># Get the shape of img</span>
<span class="gr">Out[74]: </span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">511</span><span class="p">)</span>

<span class="gp">In [75]: </span><span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="c"># Call object method min with no arguments</span>
<span class="gr">Out[75]: </span><span class="o">-</span><span class="mf">44424.844</span>
</pre></div>
</div>
</div>
<div class="section" id="numpy-basics">
<h2><a class="toc-backref" href="#id4">NumPy basics</a><a class="headerlink" href="#numpy-basics" title="Permalink to this headline">¶</a></h2>
<p>Before going further on the spectral extraction project we need to learn about
a few key features of NumPy.</p>
<div class="section" id="making-arrays">
<h3><a class="toc-backref" href="#id5">Making arrays</a><a class="headerlink" href="#making-arrays" title="Permalink to this headline">¶</a></h3>
<p>Arrays can be created in different ways:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [76]: </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>   <span class="c"># create an array from a list of values</span>

<span class="gp">In [77]: </span><span class="n">a</span>
<span class="gr">Out[77]: </span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>

<span class="gp">In [78]: </span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>                 <span class="c"># create an array of 4 integers, from 0 to 3</span>

<span class="gp">In [79]: </span><span class="n">b</span>
<span class="gr">Out[79]: </span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="gp">In [80]: </span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>      <span class="c"># create an array of 5 evenly spaced samples from -pi to pi</span>
<span class="gr">Out[80]: </span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">3.14159265</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.57079633</span><span class="p">,</span>  <span class="mf">0.</span>        <span class="p">,</span>  <span class="mf">1.57079633</span><span class="p">,</span>  <span class="mf">3.14159265</span><span class="p">])</span>

<span class="gp">In [81]: </span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="c"># create a log-spaced array of 9 floats between (and including) 10 and 1000</span>
<span class="gr">Out[81]: </span>
<span class="go">array([   10.        ,    17.7827941 ,    31.6227766 ,    56.23413252,</span>
<span class="go">         100.        ,   177.827941  ,   316.22776602,   562.34132519,</span>
<span class="go">        1000.        ])</span>
</pre></div>
</div>
<p>The function <tt class="docutils literal"><span class="pre">arange</span></tt> is better only used when working with integer arguments.</p>
<p class="flip6">Click to Show/Hide Tip: creating sequences of numbers </p> <div class="panel6"><div class="admonition-tip-creating-sequences-of-numbers admonition ">
<p class="first admonition-title">TIP: creating sequences of numbers</p>
<p>A general interface for creating arrays in provided by <tt class="docutils literal"><span class="pre">np.mgrid</span></tt>. The syntax
is slightly different than before, because it uses index slices instead of arguments.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [82]: </span><span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
<span class="gr">Out[82]: </span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="gp">In [83]: </span><span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="n">j</span><span class="p">]</span>
<span class="gr">Out[83]: </span>
<span class="go">array([ 0.        ,  0.55555556,  1.11111111,  1.66666667,  2.22222222,</span>
<span class="go">        2.77777778,  3.33333333,  3.88888889,  4.44444444,  5.        ])</span>
</pre></div>
</div>
<p>And in more dimensions:</p>
<div class="last highlight-ipython"><div class="highlight"><pre><span class="gp">In [84]: </span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.5</span><span class="p">]</span>

<span class="gp">In [85]: </span><span class="n">x</span>
<span class="gr">Out[85]: </span>
<span class="go">array([[-1., -1., -1., -1.],</span>
<span class="go">       [ 0.,  0.,  0.,  0.],</span>
<span class="go">       [ 1.,  1.,  1.,  1.],</span>
<span class="go">       [ 2.,  2.,  2.,  2.],</span>
<span class="go">       [ 3.,  3.,  3.,  3.]])</span>

<span class="gp">In [86]: </span><span class="n">y</span>
<span class="gr">Out[86]: </span>
<span class="go">array([[ 0. ,  0.5,  1. ,  1.5],</span>
<span class="go">       [ 0. ,  0.5,  1. ,  1.5],</span>
<span class="go">       [ 0. ,  0.5,  1. ,  1.5],</span>
<span class="go">       [ 0. ,  0.5,  1. ,  1.5],</span>
<span class="go">       [ 0. ,  0.5,  1. ,  1.5]])</span>
</pre></div>
</div>
</div>
</div><p>New arrays can be obtained by operating with existing arrays:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [87]: </span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>            <span class="c"># elementwise operations</span>
<span class="gr">Out[87]: </span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">49</span><span class="p">])</span>
</pre></div>
</div>
<p>Arrays may have more than one dimension:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [88]: </span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>                 <span class="c"># 3 x 4 float array of ones</span>

<span class="gp">In [89]: </span><span class="n">f</span>
<span class="gr">Out[89]: </span>
<span class="go">array([[ 1.,  1.,  1.,  1.],</span>
<span class="go">       [ 1.,  1.,  1.,  1.],</span>
<span class="go">       [ 1.,  1.,  1.,  1.]])</span>

<span class="gp">In [90]: </span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>  <span class="c"># 3 x 4 x 5 int array of zeros</span>

<span class="gp">In [91]: </span><span class="n">g</span>
<span class="gr">Out[91]: </span>
<span class="go">array([[[0, 0, 0, 0],</span>
<span class="go">        [0, 0, 0, 0],</span>
<span class="go">        [0, 0, 0, 0]],</span>

<span class="go">       [[0, 0, 0, 0],</span>
<span class="go">        [0, 0, 0, 0],</span>
<span class="go">        [0, 0, 0, 0]]])</span>

<span class="gp">In [92]: </span><span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                <span class="c"># array of zeros with same shape/type as f</span>
</pre></div>
</div>
<p>You can change the dimensions of existing arrays:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [93]: </span><span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="gp">In [94]: </span><span class="n">w</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>       <span class="c"># does not modify the total number of elements</span>

<span class="gp">In [95]: </span><span class="n">w</span>
<span class="gr">Out[95]: </span>
<span class="go">array([[ 0,  1,  2,  3],</span>
<span class="go">       [ 4,  5,  6,  7],</span>
<span class="go">       [ 8,  9, 10, 11]])</span>

<span class="gp">In [96]: </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">In [97]: </span><span class="n">x</span>
<span class="gr">Out[97]: </span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="gp">In [98]: </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="gp">In [99]: </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># Same thing but NumPy figures out correct length</span>

<span class="gp">In [100]: </span><span class="n">y</span>
<span class="gr">Out[100]: </span>
<span class="go">array([[0],</span>
<span class="go">       [1],</span>
<span class="go">       [2],</span>
<span class="go">       [3],</span>
<span class="go">       [4]])</span>
</pre></div>
</div>
<p>It is possible to operate with arrays of different dimensions as long as they fit well (broadcasting):</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [101]: </span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">10</span>
<span class="gr">Out[101]: </span>
<span class="go">array([[ 0,  1,  2,  3,  4],</span>
<span class="go">       [10, 11, 12, 13, 14],</span>
<span class="go">       [20, 21, 22, 23, 24],</span>
<span class="go">       [30, 31, 32, 33, 34],</span>
<span class="go">       [40, 41, 42, 43, 44]])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Lists and array behave fundamentally different!</p>
<div class="last highlight-ipython"><div class="highlight"><pre><span class="gp">In [102]: </span><span class="n">mylist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="gp">In [103]: </span><span class="n">myarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>

<span class="gp">In [104]: </span><span class="n">mylist</span><span class="o">*</span><span class="mi">2</span>
<span class="gr">Out[104]: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="gp">In [105]: </span><span class="n">myarray</span><span class="o">*</span><span class="mi">2</span>
<span class="gr">Out[105]: </span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="admonition-exercise-make-a-ripple admonition ">
<p class="first admonition-title">Exercise: Make a ripple</p>
<p class="last">Calculate a surface <tt class="docutils literal"><span class="pre">z</span> <span class="pre">=</span> <span class="pre">cos(r)</span> <span class="pre">/</span> <span class="pre">(r</span> <span class="pre">+</span> <span class="pre">5)</span></tt> where <tt class="docutils literal"><span class="pre">r</span> <span class="pre">=</span> <span class="pre">sqrt(x**2</span> <span class="pre">+</span>
<span class="pre">y**2)</span></tt>.  Set <tt class="docutils literal"><span class="pre">x</span></tt> to an array that goes from -20 to 20 stepping by 0.25
Make <tt class="docutils literal"><span class="pre">y</span></tt> the same as <tt class="docutils literal"><span class="pre">x</span></tt> but &#8220;transposed&#8221; using the <tt class="docutils literal"><span class="pre">reshape</span></tt> trick above.
Use <cite>plt.imshow</cite> to display the image of <tt class="docutils literal"><span class="pre">z</span></tt>.</p>
</div>
<p class="flip7">Click to Show/Hide Solution</p> <div class="panel7"><div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [106]: </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

<span class="gp">In [107]: </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="gp">In [108]: </span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c"># note the broadcasting behaviour</span>

<span class="gp">In [109]: </span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>

<span class="gp">In [110]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>
<span class="gr">Out[110]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb119fcc</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>or alternatively:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [111]: </span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">]</span>

<span class="gp">In [112]: </span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c"># broadcasting not needed because x and y have the same shape</span>

<span class="gp">In [113]: </span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>

<span class="gp">In [114]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>
<span class="gr">Out[114]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb12326c</span><span class="o">&gt;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ripple.png"><img alt="../_images/ripple.png" src="../_images/ripple.png" style="width: 406.0px; height: 306.0px;" /></a>
</div></div>
<div class="section" id="array-access-and-slicing">
<h3><a class="toc-backref" href="#id6">Array access and slicing</a><a class="headerlink" href="#array-access-and-slicing" title="Permalink to this headline">¶</a></h3>
<p>NumPy provides powerful methods for accessing array elements or particular subsets of an array,
e.g. the 4th column or every other row.  This is called slicing.  The outputs
below illustrate basic slicing, but you don&#8217;t need to type these examples:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [115]: </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">In [116]: </span><span class="n">a</span>
<span class="gr">Out[116]: </span>
<span class="go">array([[ 0,  1,  2,  3,  4],</span>
<span class="go">       [ 5,  6,  7,  8,  9],</span>
<span class="go">       [10, 11, 12, 13, 14],</span>
<span class="go">       [15, 16, 17, 18, 19]])</span>

<span class="gp">In [117]: </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>   <span class="c"># select element in row 2, col 3 (counting from 0)</span>
<span class="gr">Out[117]: </span><span class="mi">13</span>

<span class="gp">In [118]: </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>   <span class="c"># select every element in row 2</span>
<span class="gr">Out[118]: </span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="gp">In [119]: </span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c"># select every element in col 0</span>
<span class="gr">Out[119]: </span><span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>

<span class="gp">In [120]: </span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="gr">Out[120]: </span>
<span class="go">array([[ 1,  2],</span>
<span class="go">       [ 6,  7],</span>
<span class="go">       [11, 12]])</span>
</pre></div>
</div>
<p>As a first practical
example plot column 300 of the longslit image to look at the spatial profile:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [121]: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>             <span class="c"># make a new figure -- by default matplotlib overplots.</span>
<span class="gr">Out[121]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb10cecc</span><span class="o">&gt;</span>

<span class="gp">In [122]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="mi">300</span><span class="p">])</span>
<span class="gr">Out[122]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xb0764ac</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that as long as you don&#8217;t close existing figures, they will be kept in memory.
If you want to close the current figure, call <tt class="docutils literal"><span class="pre">plt.close()</span></tt>. If you want to
close all figures call <tt class="docutils literal"><span class="pre">plt.close('all')</span></tt>.</p>
<a class="reference internal image-reference" href="../_images/img_col300.png"><img alt="../_images/img_col300.png" src="../_images/img_col300.png" style="width: 406.0px; height: 306.0px;" /></a>
<p>The full slicing syntax also allows for a step size:</p>
<div class="highlight-python"><pre>&lt;slice&gt; = i0:i1:step
array[&lt;slice0&gt;, &lt;slice1&gt;, ...]</pre>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">i0</span></tt> is the first index value (default is zero if not provided)</li>
<li><tt class="docutils literal"><span class="pre">i1</span></tt> is the index upper bound (default is last element index + 1)</li>
<li><tt class="docutils literal"><span class="pre">step</span></tt> is the step size (default is one).  When <tt class="docutils literal"><span class="pre">step</span></tt> is not specified then the final &#8221;:&#8221; is not required.</li>
</ul>
<div class="admonition-exercise-slice-the-error-array admonition ">
<p class="first admonition-title">Exercise: Slice the error array</p>
<ul class="last simple">
<li>For row 254 of the error array <tt class="docutils literal"><span class="pre">err</span></tt> plot columns 10 to 200 stepping by 3.</li>
<li>Print a rectangular region slice of the data quality with rows 251 to 253 (inclusive) and columns 101 to
104 (inclusive).  What did you learn about the index upper bound value?</li>
</ul>
</div>
<p class="flip8">Click to Show/Hide Solution</p> <div class="panel8"><div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [123]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [124]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="mi">254</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">200</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
<span class="gr">Out[124]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbb8448c</span><span class="o">&gt;</span><span class="p">]</span>

<span class="gp">In [125]: </span><span class="n">dq</span><span class="p">[</span><span class="mi">251</span><span class="p">:</span><span class="mi">254</span><span class="p">,</span> <span class="mi">101</span><span class="p">:</span><span class="mi">105</span><span class="p">]</span>
<span class="gr">Out[125]: </span>
<span class="go">array([[   0, 1024, 1024, 1024],</span>
<span class="go">       [  16, 1040, 1024, 1024],</span>
<span class="go">       [   0, 1024, 1040, 1024]], dtype=int16)</span>
</pre></div>
</div>
<p>The index upper bound <tt class="docutils literal"><span class="pre">i1</span></tt> is one more than the final index that gets
included in the slice.  In other words the slice includes everything up to,
<em>but not including</em>, the index upper bound <tt class="docutils literal"><span class="pre">i1</span></tt>.  There are good reasons for
this, but for now just accept and learn it.</p>
<a class="reference internal image-reference" href="../_images/err_row254.png"><img alt="../_images/err_row254.png" src="../_images/err_row254.png" style="width: 406.0px; height: 306.0px;" /></a>
</div></div>
</div>
<div class="section" id="plot-the-spatial-profile-and-raw-spectrum">
<h2><a class="toc-backref" href="#id7">Plot the spatial profile and raw spectrum</a><a class="headerlink" href="#plot-the-spatial-profile-and-raw-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Plot the spatial profile by summing along the wavelength direction:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [126]: </span><span class="n">profile</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">In [127]: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="gr">Out[127]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbb89eac</span><span class="o">&gt;</span>

<span class="gp">In [128]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="gr">Out[128]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbbf14ac</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now plot the spectrum by summing along the spatial direction:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [129]: </span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="gp">In [130]: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="gr">Out[130]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbbf1e6c</span><span class="o">&gt;</span>

<span class="gp">In [131]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
<span class="gr">Out[131]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbc7d66c</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>Since most of the sum is in the background region there is a lot of noise and
cosmic-ray contamination.</p>
<a class="reference internal image-reference" href="../_images/profile.png"><img alt="../_images/profile.png" src="../_images/profile.png" style="width: 406.0px; height: 306.0px;" /></a>
<a class="reference internal image-reference" href="../_images/spectrum_noisy.png"><img alt="../_images/spectrum_noisy.png" src="../_images/spectrum_noisy.png" style="width: 406.0px; height: 306.0px;" /></a>
<div class="admonition-exercise-use-slicing-to-make-a-better-spectrum-plot admonition ">
<p class="first admonition-title">Exercise: Use slicing to make a better spectrum plot</p>
<p class="last">Use slicing to do the spectrum sum using only the rows in the image where
there is a signal from the source.
Hint: zoom into the profile plot to find the right row range.</p>
</div>
<p class="flip9">Click to Show/Hide Solution</p> <div class="panel9"><div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [132]: </span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">250</span><span class="p">:</span><span class="mi">260</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="gp">In [133]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [134]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
<span class="gr">Out[134]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xbcb9e4c</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/spectrum_clean.png"><img alt="../_images/spectrum_clean.png" src="../_images/spectrum_clean.png" style="width: 406.0px; height: 306.0px;" /></a>
</div></div>
<div class="section" id="filter-cosmic-rays-from-the-background">
<h2><a class="toc-backref" href="#id8">Filter cosmic rays from the background</a><a class="headerlink" href="#filter-cosmic-rays-from-the-background" title="Permalink to this headline">¶</a></h2>
<p>Plot five columns (wavelength) from the spectrum image as follows:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [135]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [136]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="mi">254</span><span class="p">:</span><span class="mi">259</span><span class="p">])</span>
<span class="gr">Out[136]: </span>
<span class="go">[&lt;matplotlib.lines.Line2D object at 0xbd51f4c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xbd51fec&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xbdb016c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xbdb024c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xbdb032c&gt;]</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/img_row254_noisy.png"><img alt="../_images/img_row254_noisy.png" src="../_images/img_row254_noisy.png" style="width: 406.0px; height: 306.0px;" /></a>
<p>The basic idea in spectral extraction is to subtract out the background and sum
over rows with the source signal.</p>
<p>It&#8217;s evident that there are significant cosmic ray defects in the data.  In
order to do a good job of subtracting the background we need to filter them
out.  Doing this correctly in general is difficult and in reality one would
just use the answers already provided by STSci.</p>
<p><strong>Strategy</strong>: Use a median filter to smooth out single-pixel deviations.  Then
use sigma-clipping to remove large variations between the actual and smoothed
image.</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [137]: </span><span class="kn">import</span> <span class="nn">scipy.signal</span>

<span class="gp">In [138]: </span><span class="n">img_sm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="gp">In [139]: </span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="gp">In [140]: </span><span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">img_sm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">&gt;</span> <span class="mf">8.0</span>

<span class="gp">In [141]: </span><span class="n">img_cr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="gp">In [142]: </span><span class="n">img_cr</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_sm</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span>

<span class="gp">In [143]: </span><span class="n">img_cr</span><span class="p">[</span><span class="mi">230</span><span class="p">:</span><span class="mi">280</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">230</span><span class="p">:</span><span class="mi">280</span><span class="p">,:]</span>  <span class="c"># Filter only for background</span>
</pre></div>
</div>
<p>Check if it worked:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [144]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [145]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img_cr</span><span class="p">[:,</span> <span class="mi">254</span><span class="p">:</span><span class="mi">259</span><span class="p">])</span>
<span class="gr">Out[145]: </span>
<span class="go">[&lt;matplotlib.lines.Line2D object at 0xc115d6c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xc115e8c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xc115f6c&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xc115fec&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D object at 0xc11a14c&gt;]</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/img_row254_clean.png"><img alt="../_images/img_row254_clean.png" src="../_images/img_row254_clean.png" style="width: 406.0px; height: 306.0px;" /></a>
<p>This introduces the important concept of slicing with a <strong>boolean mask</strong>.  Let&#8217;s
look at a smaller example:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [146]: </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">])</span>

<span class="gp">In [147]: </span><span class="n">neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>    <span class="c"># Parentheses here for clarity but are not required</span>

<span class="gp">In [148]: </span><span class="n">neg</span>
<span class="gr">Out[148]: </span><span class="n">array</span><span class="p">([</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="gp">In [149]: </span><span class="n">a</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="gp">In [150]: </span><span class="n">a</span>
<span class="gr">Out[150]: </span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>A slightly more complex example shows that this works the same on N-d arrays
and that you can compose logical expressions:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [151]: </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">In [152]: </span><span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span>     <span class="c"># &quot;ok = a &gt; 6 &amp; a &lt; 17&quot; will FAIL!</span>

<span class="gp">In [153]: </span><span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>                  <span class="c"># Note the &quot;logical not&quot; operator</span>

<span class="gp">In [154]: </span><span class="n">a</span>
<span class="gr">Out[154]: </span>
<span class="go">array([[ 0,  0,  0,  0,  0],</span>
<span class="go">       [ 0,  0,  7,  8,  9],</span>
<span class="go">       [10, 11, 12, 13, 14],</span>
<span class="go">       [15, 16,  0,  0,  0],</span>
<span class="go">       [ 0,  0,  0,  0,  0]])</span>
</pre></div>
</div>
<div class="admonition-exercise-intermediate-circular-region-slicing admonition ">
<p class="first admonition-title">Exercise [intermediate]: circular region slicing</p>
<p class="last">Remember the surface <tt class="docutils literal"><span class="pre">z</span> <span class="pre">=</span> <span class="pre">cos(r)</span> <span class="pre">/</span> <span class="pre">(r</span> <span class="pre">+</span> <span class="pre">5)</span></tt> that you made previously.  Set
<tt class="docutils literal"><span class="pre">z</span> <span class="pre">=</span> <span class="pre">0</span></tt> for every pixel of <tt class="docutils literal"><span class="pre">z</span></tt> that is within 10 units of (x,y) = (10, 15).</p>
</div>
<p class="flip3">Click to Show/Hide Solution</p> <div class="panel3"><div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [155]: </span><span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="gp">In [156]: </span><span class="n">mask</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">10</span>

<span class="gp">In [157]: </span><span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="gp">In [158]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>
<span class="gr">Out[158]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc1333ec</span><span class="o">&gt;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/ripple_masked.png"><img alt="../_images/ripple_masked.png" src="../_images/ripple_masked.png" style="width: 406.0px; height: 306.0px;" /></a>
</div><div class="admonition-detour-copy-versus-reference admonition ">
<p class="first admonition-title">Detour: copy versus reference</p>
<dl class="docutils">
<dt><strong>Question</strong></dt>
<dd>In the median filtering commands above we wrote <tt class="docutils literal"><span class="pre">img_cr</span> <span class="pre">=</span> <span class="pre">img.copy()</span></tt>.  Why
was that needed instead of just <tt class="docutils literal"><span class="pre">img_cr</span> <span class="pre">=</span> <span class="pre">img</span></tt>?</dd>
<dt><strong>Answer</strong></dt>
<dd>Because the statement <tt class="docutils literal"><span class="pre">img_cr</span> <span class="pre">=</span> <span class="pre">img</span></tt> would just create another reference
pointing to the underlying N-d array object that <tt class="docutils literal"><span class="pre">img</span></tt> references.</dd>
</dl>
<p class="last">Variable names in Python are just pointers to the actual Python
object.  To see this clearly do the following:</p>
</div>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [159]: </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="gp">In [160]: </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span>

<span class="gp">In [161]: </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="gp">In [162]: </span><span class="n">a</span>
<span class="gr">Out[162]: </span><span class="n">array</span><span class="p">([</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">3</span><span class="p">])</span>

<span class="gp">In [163]: </span><span class="n">b</span>    <span class="c"># Still as expected after changing &quot;a&quot;</span>
<span class="gr">Out[163]: </span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="fit-the-background">
<h2><a class="toc-backref" href="#id9">Fit the background</a><a class="headerlink" href="#fit-the-background" title="Permalink to this headline">¶</a></h2>
<p>To subtract the background signal from the source region we want to fit a
quadratic to the background pixels and subtract that quadratic from the entire
image which includes the source region.</p>
<p>Let&#8217;s tackle a simpler problem first and fit the background for a single column:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [164]: </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">480</span><span class="p">))</span>  <span class="c"># Background rows</span>

<span class="gp">In [165]: </span><span class="n">y</span> <span class="o">=</span> <span class="n">img_cr</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>         <span class="c"># Background rows of column 10 of cleaned image</span>

<span class="gp">In [166]: </span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="gr">Out[166]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc121a8c</span><span class="o">&gt;</span>

<span class="gp">In [167]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="gr">Out[167]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc2389ec</span><span class="o">&gt;</span><span class="p">]</span>

<span class="gp">In [168]: </span><span class="n">pfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c"># Fit a 2nd order polynomial to (x, y) data</span>

<span class="gp">In [169]: </span><span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>   <span class="c"># Evaluate the polynomial at x</span>

<span class="gp">In [170]: </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yfit</span><span class="p">)</span>
<span class="gr">Out[170]: </span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc238eac</span><span class="o">&gt;</span><span class="p">]</span>

<span class="gp">In [171]: </span><span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/bkg_fit0.png"><img alt="../_images/bkg_fit0.png" src="../_images/bkg_fit0.png" style="width: 406.0px; height: 306.0px;" /></a>
<p>Now do this for every column and store the results in a background image:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [172]: </span><span class="n">xrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img_cr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>          <span class="c"># Array from 0 .. N_rows-1</span>

<span class="gp">In [173]: </span><span class="n">bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img_cr</span><span class="p">)</span>                 <span class="c"># Empty image for background fits</span>

<span class="gp">In [174]: </span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img_cr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>      <span class="c"># Iterate over columns</span>
<span class="gp">   .....:</span>      <span class="n">pfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_cr</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="c"># Fit poly over bkg rows for col</span>
<span class="gp">   .....:</span>      <span class="n">bkg</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">xrows</span><span class="p">)</span>   <span class="c"># Eval poly at ALL row positions</span>
<span class="gp">   .....:</span> 

<span class="gp">In [177]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [178]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bkg</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="gr">Out[178]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc2aad8c</span><span class="o">&gt;</span>

<span class="gp">In [179]: </span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="gr">Out[179]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">Colorbar</span> <span class="n">instance</span> <span class="n">at</span> <span class="mh">0xc2b11cc</span><span class="o">&gt;</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/bkg_fit1.png"><img alt="../_images/bkg_fit1.png" src="../_images/bkg_fit1.png" style="width: 406.0px; height: 306.0px;" /></a>
<p>Finally subtract this background and see if it worked:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [180]: </span><span class="n">img_bkg</span> <span class="o">=</span> <span class="n">img_cr</span> <span class="o">-</span> <span class="n">bkg</span>

<span class="gp">In [181]: </span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="gp">In [182]: </span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_bkg</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="gr">Out[182]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0xc3d2ccc</span><span class="o">&gt;</span>

<span class="gp">In [183]: </span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="gr">Out[183]: </span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">Colorbar</span> <span class="n">instance</span> <span class="n">at</span> <span class="mh">0xc3d80cc</span><span class="o">&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"><strong>Background subtracted</strong></th>
<th class="head"><strong>Original</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="first last reference internal image-reference" href="../_images/bkg_fit2.png"><img alt="../_images/bkg_fit2.png" src="../_images/bkg_fit2.png" style="width: 406.0px; height: 306.0px;" /></a>
</td>
<td><a class="first last reference internal image-reference" href="../_images/imgview_img.png"><img alt="../_images/imgview_img.png" src="../_images/imgview_img.png" style="width: 406.0px; height: 306.0px;" /></a>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="sum-the-source-signal">
<h2><a class="toc-backref" href="#id10">Sum the source signal</a><a class="headerlink" href="#sum-the-source-signal" title="Permalink to this headline">¶</a></h2>
<p>Now the final step is easy and is left as an exercise.</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"><strong>Python for Astronomers Spectrum</strong></th>
<th class="head"><strong>HST official spectrum</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="first last reference internal image-reference" href="../_images/spectrum_final.png"><img alt="../_images/spectrum_final.png" src="../_images/spectrum_final.png" style="width: 406.0px; height: 306.0px;" /></a>
</td>
<td><a class="first last reference internal image-reference" href="../_images/3c120_spec.gif"><img alt="../_images/3c120_spec.gif" src="../_images/3c120_spec.gif" style="width: 382.5px; height: 306.0px;" /></a>
</td>
</tr>
</tbody>
</table>
<div class="admonition-exercise-make-the-final-spectrum admonition ">
<p class="first admonition-title">Exercise: Make the final spectrum</p>
<p class="last">Sum the rows of the background subtracted spectrum and plot.  Hint: you
already did it once in a previous exercise.</p>
</div>
<p class="flip6">Click to Show/Hide Solution</p> <div class="panel6"><div class="highlight-python"><div class="highlight"><pre><span class="n">spectrum</span> <span class="o">=</span> <span class="n">img_bkg</span><span class="p">[</span><span class="mi">250</span><span class="p">:</span><span class="mi">260</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
</pre></div>
</div>
</div><p><strong>To do</strong>: flux calibration and wavelength calibration!</p>
</div>
<div class="section" id="scipy">
<h2><a class="toc-backref" href="#id11">SciPy</a><a class="headerlink" href="#scipy" title="Permalink to this headline">¶</a></h2>
<p>It is impossible to do justice to the full contents of the <a class="reference internal" href="#scipy">SciPy</a> package: is
entirely too large!  What is left as homework for the reader is to
click through to the main <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/">SciPy Reference Manual</a> and skim the <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/tutorial/index.html">tutorial</a>.  Keep
this repository of functionality in mind whenever you need some numerical
functionality that isn&#8217;t in NumPy: there is a good chance it is in SciPy:</p>
<ul class="simple">
<li>Basic functions in Numpy (and top-level scipy)</li>
<li>Special functions (scipy.special)</li>
<li>Integration (scipy.integrate)</li>
<li>Optimization (optimize)</li>
<li>Interpolation (scipy.interpolate)</li>
<li>Fourier Transforms (scipy.fftpack)</li>
<li>Signal Processing (signal)</li>
<li>Linear Algebra</li>
<li>Statistics</li>
<li>Multi-dimensional image processing (ndimage)</li>
<li>File IO (scipy.io)</li>
<li>Weave</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="numpy_recarray.html" title="NumPy record arrays"
             >next</a> |</li>
        <li class="right" >
          <a href="ipython.html" title="IPython"
             >previous</a> |</li>
        <li><a href="../index.html">Python4Astronomers v1.1 documentation</a> &raquo;</li>
          <li><a href="core.html" >Core packages for analysis: IPython, NumPy, and SciPy</a> &raquo;</li> 
      </ul>
    </div>
 <small>Copyright:
 Smithsonian Astrophysical Observatory under terms of
 <a rel="license"
 href="http://creativecommons.org/licenses/by/3.0/">CC
 Attribution 3.0</a></small> <a rel="license"
 href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons
 License" style="border-width:0"
 src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a>

  </body>
</html>